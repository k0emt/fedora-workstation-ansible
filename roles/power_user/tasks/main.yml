---
# tasks for power user role

- name: Install power user packages
  become: true
  dnf:
    name:
      - btop
      - bat
      - curl
      - eza
      - fzf
      - htop
      - jq
      - mc
      - fastfetch
      - rsync
      - tldr
      - tmux
      - tree
      - unzip
      - wget
      - zip
    state: present

# task to install zsh
- name: Install zsh
  become: true
  dnf:
    name: zsh
    state: present

# task to install oh-my-zsh
- name: Install Oh My Zsh
  ansible.builtin.shell:
    cmd: sh -c "$(curl -fsSL https://raw.github.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"
    creates: "{{ ansible_env.HOME }}/.oh-my-zsh"

- name: Install zsh-autosuggestions plugin # noqa: latest
  ansible.builtin.git:
    repo: https://github.com/zsh-users/zsh-autosuggestions
    dest: "{{ ansible_env.HOME }}/.oh-my-zsh/custom/plugins/zsh-autosuggestions"
    depth: 1

- name: Install zsh-completions plugin # noqa: latest
  ansible.builtin.git:
    repo: https://github.com/zsh-users/zsh-completions.git
    dest: "{{ ansible_env.HOME }}/.oh-my-zsh/custom/plugins/zsh-completions"
    depth: 1

- name: Install zsh-syntax-highlighting plugin # noqa: latest
  ansible.builtin.git:
    repo: https://github.com/zsh-users/zsh-syntax-highlighting.git
    dest: "{{ ansible_env.HOME }}/.oh-my-zsh/custom/plugins/zsh-syntax-highlighting"
    depth: 1

- name: Change user shell to zsh 
  become: true
  ansible.builtin.user:
    name: "{{ ansible_user_id }}"
    shell: /bin/zsh

# task to install Powerlevel10k theme
- name: Install Powerlevel10k theme
  ansible.builtin.git:
    repo: https://github.com/romkatv/powerlevel10k.git
    dest: "{{ ansible_env.HOME }}/.oh-my-zsh/custom/themes/powerlevel10k"
    depth: 1

# TODO copy a preconfigured zshrc file for p10k 
- name: Copy zshrc (for p10k)
  ansible.builtin.copy:
    src: zshrc-p10k
    dest: "{{ ansible_env.HOME }}/.zshrc"
    mode: 0644
  when: false # copy_dot_files

# TODO is this needed?
- name: Copy p10k.zsh
  ansible.builtin.copy:
    src: p10k.zsh
    dest: "{{ ansible_env.HOME }}/.p10k.zsh"
    mode: 0644
  when: false # copy_dot_files

# task to set Powerlevel10k theme in .zshrc
- name: Set Powerlevel10k theme in .zshrc
  lineinfile:
    path: "{{ ansible_env.HOME }}/.zshrc"
    regexp: '^ZSH_THEME='
    line: 'ZSH_THEME="powerlevel10k/powerlevel10k"'
  notify: reload zsh

# task to use oh-my-zsh plugins
- name: Use oh-my-zsh plugins
  lineinfile:
    path: "{{ ansible_env.HOME }}/.zshrc"
    regexp: '^plugins='
    line: 'plugins=(git aws web-search encode64 zsh-autosuggestions zsh-syntax-highlighting)'
  notify: reload zsh

# task to set zsh as default shell
- name: Set zsh as default shell
  become: true
  ansible.builtin.shell:
    cmd: chsh -s /usr/bin/zsh "{{ ansible_user_id }}"

# TODO extract this out into a separate FONTs task?
# task to enable copr repository for IOSevka font
# - name: Enable copr repository for IOSevka font
#   command: dnf copr enable peterwu/iosevka
#   become: true

# # task to install IOSevka fonts
# - name: Install IOSevka fonts
#   become: true
#   dnf:
#       name: 
#         - iosevka
#         # - iosevka-fixed-ss04-fonts
#         # - iosevka-term-ss04-fonts
#       state: present

  # copy file static-content/vimrc to users ~/.vimrc
- name: Copy .vimrc to user's home directory
  copy:
    src: "{{ playbook_dir }}/static-content/vimrc"
    dest: "{{ ansible_env.HOME }}/.vimrc"
    owner: "{{ ansible_user_id }}"
    group: "{{ ansible_user_id }}"
    mode: 0644
